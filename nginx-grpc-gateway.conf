# gRPC Gateway Configuration
# 将此配置放在 /etc/nginx/conf.d/ 或包含到主配置文件中

upstream auth_service {
    server localhost:50051;
    # 如果是 Docker/K8s 环境，改成:
    # server auth-service:50051;
}

upstream wiki_service {
    server localhost:50051;
    # 如果是 Docker/K8s 环境，改成:
    # server sse-wiki:50051;
}

server {
    listen 9000 http2;
    server_name localhost;

    # 路由到 auth-service
    location /authservice. {
        grpc_pass grpc://auth_service;

        # gRPC 错误处理
        error_page 502 = /error502grpc;

        # 超时设置
        grpc_read_timeout 30s;
        grpc_send_timeout 30s;
    }

    # 路由到 sse-wiki service
    location /wikiservice. {
        grpc_pass grpc://wiki_service;

        error_page 502 = /error502grpc;

        grpc_read_timeout 30s;
        grpc_send_timeout 30s;
    }

    # gRPC 错误响应
    location = /error502grpc {
        internal;
        default_type application/grpc;
        add_header grpc-status 14;
        add_header grpc-message "unavailable";
        return 204;
    }
}
